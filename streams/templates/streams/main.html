{% extends "core/base.html" %}
{% load static %}

{% block title %}Home | ClearCast{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}?v=2024111103">
<link rel="stylesheet" href="{% static 'css/modal-tabs.css' %}">
{% endblock %}

{% block extra_js %}
<script id="cfg" type="application/json">{"browserAudioProcessing": {{ browser_audio_processing|yesno:"true,false" }}}</script>
<script>
// Pass Django template variables to JavaScript
window.CURRENT_USER = "{{ user.username }}";
window.USER_ID = {{ user.id }};
</script>
<script src="{% static 'js/modal-tabs-new.js' %}?v=1720"></script>
<script src="{% static 'js/main.js' %}?v=1720"></script>
{% endblock %}

{% block content %}
<div class="layout">
    <!-- Sidebar -->
    <div class="card panel sidebar">
        <div class="sidebar-header">
            <h2>Your Profile</h2>
            <div class="friend-item you-item" data-username="{{ user.username }}" onclick="selectEntry('{{ user.username }}', true)">
                <div class="friend-name">{{ user.username }} <span class="user-chip">You</span></div>
                <div class="friend-meta">
                    {% if self_is_streaming %}
                        <span class="dot live-dot"></span>
                        Streaming
                    {% elif self_is_online %}
                        <span class="dot online-dot"></span>
                        Online
                    {% else %}
                        <span class="dot offline-dot"></span>
                        Offline
                    {% endif %}
                </div>
            </div>
            <div class="divider"></div>
            <div class="friends-header-row">
                <h2>{% if user.is_superuser or user.profile.user_level == 'admin' %}Users{% else %}Friends{% endif %}</h2>
                <button class="streaming-filter-btn" id="streaming-filter-btn" onclick="toggleStreamingFilter()" title="Filter streaming only">
                    <span class="filter-dot"></span>
                    <span>Live</span>
                </button>
                <div class="friends-search-box">
                    <span class="friends-search-icon">üîç</span>
                    <input type="text" class="friends-search-input" id="sidebar-search" placeholder="Search..." oninput="filterFriendsList()">
                </div>
            </div>
        </div>
        <div class="sidebar-content">
            <div id="friends-list">
                {% for friend in friends %}
                    <div class="friend-item" data-username="{{ friend.username }}">
                        <div class="friend-info" onclick="selectEntry('{{ friend.username }}', false)">
                            <div class="friend-name">{{ friend.username }}</div>
                            <div class="friend-meta">
                                {% if friend.is_streaming %}
                                    <span class="dot live-dot"></span>
                                    Streaming <span class="rec-icon">‚è∫</span>
                                {% elif friend.is_online %}
                                    <span class="dot online-dot"></span>
                                    Online
                                {% else %}
                                    <span class="dot offline-dot"></span>
                                    Offline
                                {% endif %}
                            </div>
                        </div>
                        <div style="position: relative;">
                            <button class="friend-options-btn" onclick="event.stopPropagation(); toggleFriendMenu('{{ friend.username }}')">‚ãÆ</button>
                            <div class="friend-options-menu" id="friend-menu-{{ friend.username }}">
                                <div class="friend-options-menu-item danger" onclick="event.stopPropagation(); showUnfriendModal('{{ friend.username }}')">Unfriend</div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                <div class="empty">No friends yet</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Main content: dynamic user/friend area -->
    <div class="card panel">
        <div class="content-header">
            <div>
                <div class="content-title" id="content-title">Select a user</div>
                <div id="content-sub" class="muted">Stream controls and recordings appear here</div>
            </div>
            <div id="live-pill" class="pill pill-off">Offline</div>
        </div>

        <div id="owner-controls" style="display:none">
            {% if can_stream %}
            <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; padding: .75rem 1rem; border:1px solid #eef2f7; border-radius:12px; background:linear-gradient(180deg,#ffffff,#fafafa)">
                <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap">
                    <button id="start-btn" class="cta" onclick="startStream()">‚ñ∂ Stream</button>
                    <button id="stop-btn" class="cta stop" onclick="stopStream()" style="display:none">
                        <span style="display:flex; align-items:center; gap:.5rem">
                            <span style="font-size:1.1em">‚ñ†</span>
                            <span>Stop</span>
                            <span id="stop-timer" style="font-weight:700; font-family:monospace; letter-spacing:0.5px; padding-left:.25rem; border-left:1px solid rgba(255,255,255,0.3)">00:00</span>
                        </span>
                    </button>
                    <!-- Hidden checkbox preserved for logic; visible toggle is a button -->
                    <input type="checkbox" id="denoise-toggle" checked style="display:none">
                    <button id="denoise-btn" type="button" class="toggle-pill toggle-on" onclick="toggleDenoise()" title="Toggle denoise before starting stream">Denoise: ON</button>
                    <!-- Denoise status label (shown during streaming) -->
                    <span id="denoise-status" style="display:none; padding:.35rem .65rem; border-radius:8px; font-size:0.85rem; font-weight:600; background:#10b981; color:#fff;">
                        ‚úì Denoise: ON
                    </span>
                    <!-- Sound wave animation (hidden by default, shown when streaming) -->
                    <div class="sound-wave" id="sound-wave" style="display:none">
                        {% for i in "x"|rjust:45 %}
                        <span class="bar"></span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div id="stream-status" class="muted" style="margin:.5rem 0 1rem"></div>
            {% else %}
            <div style="padding: 1rem; border:1px solid #fee2e2; border-radius:12px; background:#fef2f2; color:#991b1b; text-align:center;">
                <strong>‚ö† Streaming Disabled</strong><br>
                <span style="font-size:0.875rem;">Your account does not have permission to stream.</span>
            </div>
            {% endif %}
        </div>

        <div id="listener-controls" style="display:none">
            <div class="controls">
                <button id="listen-btn" class="cta-listen" onclick="startListening()">Start Listening</button>
                <button id="stop-listen-btn" class="cta-listen stop" onclick="stopListening()" style="display:none">Stop Listening</button>
            </div>
            <audio id="remote-audio" autoplay controls style="display:none; margin-top:.75rem"></audio>
            <div id="listen-status" class="muted" style="margin-top:.5rem"></div>
        </div>

        <div class="divider"></div>
        <h2>Recordings</h2>
        <div id="recordings-list" class="list"></div>
        <div id="no-recordings" class="empty" style="display:none">No recordings yet</div>
    </div>

</div>

<!-- Friends Modal -->
<div id="friends-modal" class="modal-overlay" onclick="if(event.target === this) closeFriendsModal()">
    <div class="friends-modal-box">
        <div class="friends-modal-header">
            <h2 style="margin: 0;">Friends</h2>
            <button class="friends-modal-close" onclick="closeFriendsModal()">&times;</button>
        </div>
        <div class="divider" style="margin: 0.5rem 0 1rem;"></div>
        
        <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Find Friends</h2>
        <div class="search">
            <input id="search-input" type="text" placeholder="Search usernames..." autocomplete="off" />
        </div>
        <div id="search-results" class="list"></div>
        
        <div class="divider"></div>
        
        <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Friend Requests</h2>
        <div id="requests" class="list"></div>
    </div>
</div>

<!-- Unfriend Confirmation Modal -->
<div id="unfriend-modal" class="modal-overlay" onclick="if(event.target === this) closeUnfriendModal()">
    <div class="modal-box">
        <div class="modal-title">Unfriend User</div>
        <div class="modal-text" id="unfriend-modal-text">Are you sure you want to unfriend <strong id="unfriend-username"></strong>?</div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeUnfriendModal()">Cancel</button>
            <button class="modal-btn modal-btn-danger" onclick="confirmUnfriend()">Unfriend</button>
        </div>
    </div>
</div>

<!-- Alert Modal -->
<div id="alert-modal" class="modal-overlay" onclick="if(event.target === this) closeAlertModal()">
    <div class="alert-modal-box">
        <div class="alert-icon" id="alert-icon">‚úì</div>
        <div class="alert-title" id="alert-title">Success</div>
        <div class="alert-message" id="alert-message">Operation completed successfully</div>
        <button class="alert-btn success" id="alert-btn" onclick="closeAlertModal()">OK</button>
    </div>
</div>

<!-- Audio Processing Modal (Denoise, Vocal Separation, Volume Boost) -->
<div id="denoise-modal" class="modal-overlay" onclick="if(event.target === this) closeDenoiseModal()">
    <div class="friends-modal-box" style="max-width: 700px;">
        <div class="friends-modal-header">
            <h2 style="margin: 0;">Audio Processing</h2>
            <button class="friends-modal-close" onclick="closeDenoiseModal()">&times;</button>
        </div>
        <div class="divider" style="margin: 0.5rem 0 1rem;"></div>
        
        <!-- Tabs -->
        <div class="modal-tabs">
            <button class="modal-tab active" data-tab="denoise" onclick="switchModalTab('denoise')">
                <span>‚ú®</span>
                <span>File Denoise</span>
            </button>
            <button class="modal-tab" data-tab="vocal" onclick="switchModalTab('vocal')">
                <span>üé§</span>
                <span>Vocal Separation</span>
            </button>
            <button class="modal-tab" data-tab="boost" onclick="switchModalTab('boost')">
                <span>üîä</span>
                <span>Volume Boost</span>
            </button>
            <button class="modal-tab" data-tab="speaker" onclick="switchModalTab('speaker')">
                <span>üéØ</span>
                <span>Voice Extraction</span>
            </button>
        </div>
        
        <!-- Tab Content: File Denoise -->
        <div class="modal-tab-content active" id="denoise-tab-content">
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Upload Your Audio File</h3>
            <form id="upload-form" enctype="multipart/form-data" style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 0.75rem; align-items: stretch; flex-wrap: wrap;">
                    <div class="file-input-wrapper" id="file-input-wrapper" style="flex: 1; min-width: 200px; height: 56px;">
                        <label for="audio-file-input" class="file-input-label" style="height: 100%;">
                            <span class="file-input-icon">üìÅ</span>
                            <div class="file-input-text">
                                <div class="file-input-main" id="file-input-main">Choose an audio file</div>
                                <div class="file-input-sub" id="file-input-sub">WAV, MP3, FLAC, OGG, M4A</div>
                            </div>
                            <button type="button" class="file-input-clear" id="file-input-clear" style="display: none;" onclick="clearFileInput(event)">‚úï</button>
                        </label>
                        <input type="file" id="audio-file-input" accept="audio/*,.wav,.mp3,.flac,.ogg,.m4a" />
                    </div>
                    <div class="volume-boost-controls" style="height: 56px;" id="volume-boost-container" onclick="handleBoostContainerClick(event)">
                        <div class="boost-header">
                            <span class="boost-label" id="boost-label-toggle">üîä Volume Boost</span>
                        </div>
                        <div class="boost-slider-container">
                            <input type="range" id="denoise-boost-level" class="boost-slider" min="2" max="5" value="3" step="1" disabled oninput="updateBoostLabel()" onclick="event.stopPropagation()">
                            <span id="denoise-boost-value" class="boost-value">3x</span>
                        </div>
                    </div>
                    <button type="submit" class="btn-upload-denoise" style="height: 56px; padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); white-space: nowrap;">
                        <span>‚ú®</span>
                        <span>Denoise</span> 
                    </button>
                </div>
                <div id="upload-status" class="muted" style="margin-top: 0.5rem;"></div>
            </form>
            
            <div class="divider"></div>
            
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Your Files</h3>
            <div id="denoise-files-list" style="max-height: 300px; overflow-y: auto;">
                <div class="empty">No files yet</div>
            </div>
        </div>
        
        <!-- Tab Content: Vocal Separation -->
        <div class="modal-tab-content" id="vocal-tab-content">
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Upload Audio for Vocal Separation</h3>
            <form id="vocal-upload-form" enctype="multipart/form-data" style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 0.75rem; align-items: stretch;">
                    <div class="file-input-wrapper" id="vocal-file-input-wrapper">
                        <label for="vocal-file-input" class="file-input-label">
                            <span class="file-input-icon">üìÅ</span>
                            <div class="file-input-text">
                                <div class="file-input-main" id="vocal-file-input-main">Choose an audio file</div>
                                <div class="file-input-sub" id="vocal-file-input-sub">WAV, MP3, FLAC, OGG, M4A</div>
                            </div>
                            <button type="button" class="file-input-clear" id="vocal-file-input-clear" style="display: none;" onclick="clearVocalFileInput(event)">‚úï</button>
                        </label>
                        <input type="file" id="vocal-file-input" accept="audio/*,.wav,.mp3,.flac,.ogg,.m4a" />
                    </div>
                    <button type="submit" class="btn-upload-denoise">
                        <span>üé§</span>
                        <span>Separate Vocals</span>
                    </button>
                </div>
                <div id="vocal-upload-status" class="muted" style="margin-top: 0.5rem;"></div>
            </form>
            
            <div class="divider"></div>
            
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Your Separated Files</h3>
            <div id="vocal-files-list" style="max-height: 300px; overflow-y: auto;">
                <div class="empty">No files yet</div>
            </div>
        </div>
        
        <!-- Tab Content: Volume Boost -->
        <div class="modal-tab-content" id="boost-tab-content">
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Upload Audio for Volume Boost</h3>
            <form id="boost-upload-form" enctype="multipart/form-data" style="margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 0.75rem; align-items: stretch;">
                    <div class="file-input-wrapper" id="boost-file-input-wrapper" style="flex: 1; min-width: 200px; height: 56px;">
                        <label for="boost-file-input" class="file-input-label" style="height: 100%;">
                            <span class="file-input-icon">üìÅ</span>
                            <div class="file-input-text">
                                <div class="file-input-main" id="boost-file-input-main">Choose an audio file</div>
                                <div class="file-input-sub" id="boost-file-input-sub">WAV, MP3, FLAC, OGG, M4A</div>
                            </div>
                            <button type="button" class="file-input-clear" id="boost-file-input-clear" style="display: none;" onclick="clearBoostFileInput(event)">‚úï</button>
                        </label>
                        <input type="file" id="boost-file-input" accept="audio/*,.wav,.mp3,.flac,.ogg,.m4a" />
                    </div>
                    <div class="volume-boost-controls" style="height: 56px;">
                        <div class="boost-header">
                            <span class="boost-label-static">üîä Volume Boost</span>
                        </div>
                        <div class="boost-slider-container">
                            <input type="range" id="boost-level" class="boost-slider" min="2" max="5" value="3" step="1" oninput="updateBoostTabLabel()">
                            <span id="boost-level-value" class="boost-value">3x</span>
                        </div>
                    </div>
                    <button type="submit" class="btn-upload-denoise" style="height: 56px; padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); white-space: nowrap;">
                        <span>üîä</span>
                        <span>Boost Volume</span>
                    </button>
                </div>
                <div id="boost-upload-status" class="muted" style="margin-top: 0.5rem;"></div>
            </form>
            
            <div class="divider"></div>
            
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Your Boosted Files</h3>
            <div id="boost-files-list" style="max-height: 300px; overflow-y: auto;">
                <div class="empty">No files yet</div>
            </div>
        </div>
        
        <!-- Tab Content: Voice Extraction -->
        <div class="modal-tab-content" id="speaker-tab-content">
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Extract Target Speaker's Voice</h3>
            <form id="speaker-upload-form" enctype="multipart/form-data" style="margin-bottom: 1.5rem;">
                <!-- First Row: File Inputs + Volume Boost -->
                <div style="display: flex; gap: 0.75rem; align-items: stretch; margin-bottom: 0.75rem;">
                    <!-- Conversation File -->
                    <div class="file-input-wrapper" id="speaker-conversation-input-wrapper" style="flex: 1; min-width: 200px; height: 56px;">
                        <label for="speaker-conversation-input" class="file-input-label" style="height: 100%;">
                            <div class="file-input-text">
                                <div class="file-input-main" id="speaker-conversation-main">Conversation audio</div>
                                <div class="file-input-sub" id="speaker-conversation-sub">Multi-speaker recording</div>
                            </div>
                            <button type="button" class="file-input-clear" id="speaker-conversation-clear" style="display: none;" onclick="clearSpeakerConversationInput(event)">‚úï</button>
                        </label>
                        <input type="file" id="speaker-conversation-input" accept="audio/*,.wav,.mp3,.flac,.ogg,.m4a" />
                    </div>
                    
                    <!-- Target Speaker File -->
                    <div class="file-input-wrapper" id="speaker-target-input-wrapper" style="flex: 1; min-width: 200px; height: 56px;">
                        <label for="speaker-target-input" class="file-input-label" style="height: 100%;">
                            <div class="file-input-text">
                                <div class="file-input-main" id="speaker-target-main">Target speaker sample</div>
                                <div class="file-input-sub" id="speaker-target-sub">Voice sample to extract</div>
                            </div>
                            <button type="button" class="file-input-clear" id="speaker-target-clear" style="display: none;" onclick="clearSpeakerTargetInput(event)">‚úï</button>
                        </label>
                        <input type="file" id="speaker-target-input" accept="audio/*,.wav,.mp3,.flac,.ogg,.m4a" />
                    </div>
                    
                    <!-- Volume Boost Controls -->
                    <div class="volume-boost-controls" style="height: 56px;" id="speaker-volume-boost-container" onclick="handleSpeakerBoostContainerClick(event)">
                        <div class="boost-header">
                            <span class="boost-label" id="speaker-boost-label-toggle">üîä Volume Boost</span>
                        </div>
                        <div class="boost-slider-container">
                            <input type="range" id="speaker-boost-level" class="boost-slider" min="2" max="5" value="3" step="1" disabled oninput="updateSpeakerBoostLabel()" onclick="event.stopPropagation()">
                            <span id="speaker-boost-value" class="boost-value">3x</span>
                        </div>
                    </div>
                </div>
                
                <!-- Second Row: Extract Button -->
                <div style="display: flex; gap: 0.75rem; align-items: stretch;">
                    <!-- Submit Button -->
                    <button type="submit" class="btn-upload-denoise" style="height: 56px; padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); white-space: nowrap; width: 100%;">
                        <span>üéØ</span>
                        <span>Extract Voice</span>
                    </button>
                </div>
                
                <div id="speaker-upload-status" class="muted" style="margin-top: 0.5rem;"></div>
            </form>
            
            <div class="divider"></div>
            
            <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Your Extracted Voices</h3>
            <div id="speaker-files-list" style="max-height: 300px; overflow-y: auto;">
                <div class="empty">No files yet</div>
            </div>
        </div>
    </div>
</div>

<!-- Delete File Confirmation Modal -->
<div id="delete-file-modal" class="modal-overlay" onclick="if(event.target === this) closeDeleteFileModal()">
    <div class="modal-box">
        <div class="modal-title">Delete Audio File</div>
        <div class="modal-text">
            Are you sure you want to delete <strong id="delete-file-name"></strong>?
            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px; font-size: 0.9rem; color: #92400e;">
                ‚ö†Ô∏è This will permanently delete both the original and denoised files.
            </div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteFileModal()">Cancel</button>
            <button class="modal-btn modal-btn-danger" onclick="confirmDeleteFile()">Delete</button>
        </div>
    </div>
</div>

{% endblock %}

