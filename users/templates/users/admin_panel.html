{% extends "core/base.html" %}
{% load static %}

{% block title %}Admin Panel - User Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_panel.css' %}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="table-controls">
        <div class="table-controls-left">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="search-input" placeholder="Search users..." oninput="handleSearch()">
            </div>
            <div class="results-info" id="results-info">
                Loading...
            </div>
        </div>
        <button class="btn-create" onclick="openCreateModal()">
            <span>+</span>
            <span>Create User</span>
        </button>
    </div>
    
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="username" onclick="handleSort('username')">Username</th>
                    <th class="sortable" data-sort="name" onclick="handleSort('name')">Name</th>
                    <th class="sortable" data-sort="email" onclick="handleSort('email')">Email</th>
                    <th class="sortable" data-sort="user_level" onclick="handleSort('user_level')">Level</th>
                    <th class="sortable" data-sort="allow_stream" onclick="handleSort('allow_stream')">Stream Access</th>
                    <th class="sortable" data-sort="date_joined" onclick="handleSort('date_joined')">Date Joined</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <tr>
                    <td colspan="6" class="loading">Loading users...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination-container">
        <div class="pagination-info" id="pagination-info">
            Showing 0 of 0 users
        </div>
        <div class="pagination-controls">
            <span class="page-size-label">Per page:</span>
            <select class="page-size-select" id="page-size" onchange="handlePageSizeChange()">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <button class="page-btn" id="prev-btn" onclick="prevPage()" disabled>‚Üê Prev</button>
            <span id="page-numbers" style="display: flex; gap: 0.25rem;"></span>
            <button class="page-btn" id="next-btn" onclick="nextPage()" disabled>Next ‚Üí</button>
        </div>
    </div>
</div>

<!-- Delete User Confirmation Modal -->
<div id="delete-user-modal-overlay" class="delete-user-modal-overlay" style="display: none;">
    <div class="delete-user-modal">
        <div class="delete-user-modal-header">
            <span class="delete-user-modal-icon">‚ö†Ô∏è</span>
            <h3 class="delete-user-modal-title">Delete User?</h3>
        </div>
        <div class="delete-user-modal-body">
            Are you sure you want to permanently delete the user:
            <div class="delete-user-modal-username" id="delete-user-name"></div>
            <div class="delete-user-modal-warning">
                <span>‚ö†Ô∏è</span>
                <span>This action cannot be undone. All user data, recordings, and associated information will be permanently removed.</span>
            </div>
        </div>
        <div class="delete-user-modal-actions">
            <button class="delete-user-modal-btn cancel" onclick="closeDeleteUserModal()">Cancel</button>
            <button class="delete-user-modal-btn delete" onclick="confirmDeleteUser()">Delete User</button>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div id="create-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateModal()">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="modal-title">Create New User</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        
        <div id="create-error" class="error-message" style="display:none;"></div>
        
        <form id="create-form" onsubmit="handleCreateUser(event)">
            <div class="form-group">
                <label class="form-label">Username *</label>
                <input type="text" class="form-input" name="username" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password *</label>
                <input type="password" class="form-input" name="password" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" name="name">
                <div class="note">Optional</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" name="email">
                <div class="note">Optional</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">User Level</label>
                <select class="form-select" name="user_level">
                    <option value="regular">Regular</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" name="allow_stream" checked>
                    Allow Streaming
                </label>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn-modal btn-save">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-modal" class="modal-overlay" onclick="if(event.target === this) closeEditModal()">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="modal-title">Edit User</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        
        <div id="edit-error" class="error-message" style="display:none;"></div>
        
        <form id="edit-form" onsubmit="handleEditUser(event)">
            <input type="hidden" name="user_id" id="edit-user-id">
            
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="edit-username" readonly style="background:#f3f4f6;">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" name="password" id="edit-password">
                <div class="note">Leave blank to keep current password</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" name="name" id="edit-name">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" name="email" id="edit-email">
            </div>
            
            <div class="form-group">
                <label class="form-label">User Level</label>
                <select class="form-select" name="user_level" id="edit-user-level">
                    <option value="regular">Regular</option>
                    <option value="admin">Admin</option>
                </select>
                <div class="note" id="edit-superuser-note" style="display:none;">This is a superuser - admin privileges are permanent</div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" name="allow_stream" id="edit-allow-stream">
                    Allow Streaming
                </label>
                <div class="note" id="edit-stream-note" style="display:none;">Admins can always stream</div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-delete-user" id="btn-delete-user" onclick="showDeleteUserModal()">
                    <span>üóëÔ∏è</span>
                    <span>Delete User</span>
                </button>
                <div style="flex: 1;"></div>
                <button type="button" class="btn-modal btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-modal btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="modal-overlay" onclick="if(event.target === this) closeSuccessModal()">
    <div class="success-modal-box">
        <div class="success-icon">‚úì</div>
        <div class="success-modal-title" id="success-modal-title">Success!</div>
        <div class="success-modal-message" id="success-modal-message">Operation completed successfully</div>
        <button class="btn-success-ok" onclick="closeSuccessModal()">OK</button>
    </div>
</div>

<!-- Friends Modal -->
<div id="friends-modal" class="modal-overlay" onclick="if(event.target === this) closeFriendsModal()">
    <div class="friends-modal-box">
        <div class="friends-modal-header">
            <h2 style="margin: 0;">Friends</h2>
            <button class="friends-modal-close" onclick="closeFriendsModal()">&times;</button>
        </div>
        <div class="divider" style="margin: 0.5rem 0 1rem;"></div>
        
        <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Find Friends</h2>
        <div class="search">
            <input id="friends-search-input" type="text" placeholder="Search usernames..." autocomplete="off" />
        </div>
        <div id="friends-search-results" class="list"></div>
        
        <div class="divider"></div>
        
        <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Friend Requests</h2>
        <div id="friends-requests" class="list"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Pass Django template variables to JavaScript
window.USER_IS_SUPERUSER = {{ request.user.is_superuser|lower }};
window.CURRENT_USERNAME = '{{ request.user.username }}';
</script>
<script src="{% static 'js/admin_panel.js' %}"></script>
{% endblock %}
