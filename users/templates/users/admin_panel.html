{% extends "core/base.html" %}

{% block title %}Admin Panel - User Management{% endblock %}

{% block extra_css %}
<style>
    /* Dark mode support for admin panel */
    [data-theme="dark"] .table-controls,
    [data-theme="dark"] .users-table-container,
    [data-theme="dark"] .modal-box,
    [data-theme="dark"] .delete-user-modal {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .users-table {
        background: var(--bg-secondary) !important;
    }
    
    [data-theme="dark"] .users-table th {
        background: #3a3a3a !important;
        color: var(--text-primary) !important;
        border-color: #505050 !important;
    }
    
    [data-theme="dark"] .users-table td {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        border-color: #505050 !important;
    }
    
    [data-theme="dark"] .users-table tbody tr:hover td {
        background: #3a3a3a !important;
    }
    
    [data-theme="dark"] .search-input,
    [data-theme="dark"] .form-input,
    [data-theme="dark"] .form-select,
    [data-theme="dark"] .page-size-select {
        background: var(--input-bg) !important;
        color: var(--text-primary) !important;
        border-color: var(--input-border) !important;
    }
    
    [data-theme="dark"] .modal-overlay,
    [data-theme="dark"] .delete-user-modal-overlay {
        background: var(--modal-overlay) !important;
    }
    
    [data-theme="dark"] .results-info,
    [data-theme="dark"] .note,
    [data-theme="dark"] .muted {
        color: var(--text-secondary) !important;
    }
    
    [data-theme="dark"] .modal-title,
    [data-theme="dark"] .delete-user-modal-title {
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .form-label {
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .username-link {
        color: #60a5fa !important;
    }
    
    [data-theme="dark"] .username-link:hover {
        color: #93c5fd !important;
    }
    
    /* Table footer - pagination container and controls in dark mode */
    [data-theme="dark"] .pagination-container {
        background: var(--bg-secondary) !important;
        border-color: #505050 !important;
        box-shadow: 0 4px 12px var(--shadow-heavy) !important;
    }
    
    [data-theme="dark"] .pagination-controls {
        background: transparent !important;
    }
    
    [data-theme="dark"] .page-size-label,
    [data-theme="dark"] .pagination-info {
        color: var(--text-secondary) !important;
    }
    
    [data-theme="dark"] .page-btn {
        background: #3a3a3a !important;
        color: var(--text-primary) !important;
        border-color: #505050 !important;
    }
    
    [data-theme="dark"] .page-btn:hover:not(:disabled) {
        background: #454545 !important;
    }
    
    [data-theme="dark"] .page-btn:disabled {
        opacity: 0.4 !important;
        color: var(--text-muted) !important;
    }
    
    [data-theme="dark"] .page-btn.active {
        background: #4f46e5 !important;
        color: white !important;
    }
    
    /* Success and error messages in dark mode */
    [data-theme="dark"] .success-message {
        background: rgba(16, 185, 129, 0.15) !important;
        color: #6ee7b7 !important;
        border-color: #34d399 !important;
    }
    
    [data-theme="dark"] .error-message {
        background: rgba(239, 68, 68, 0.15) !important;
        color: #fca5a5 !important;
        border-color: #f87171 !important;
    }
    
    /* Modal close button in dark mode */
    [data-theme="dark"] .modal-close {
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .modal-close:hover {
        background: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* *** FRIENDS MODAL IN ADMIN PANEL *** */
    [data-theme="dark"] .friends-modal-box {
        background: var(--bg-secondary) !important;
        color: var(--text-primary) !important;
        box-shadow: 0 20px 60px var(--shadow-heavy) !important;
    }
    
    [data-theme="dark"] .friends-modal-header h2 {
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .friends-modal-close {
        color: var(--text-secondary) !important;
    }
    
    [data-theme="dark"] .friends-modal-close:hover {
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .search input,
    [data-theme="dark"] #friends-search-input {
        background: var(--input-bg) !important;
        color: var(--text-primary) !important;
        border-color: var(--input-border) !important;
    }
    
    [data-theme="dark"] .list {
        background: transparent !important;
    }
    
    [data-theme="dark"] #friends-search-results,
    [data-theme="dark"] #friends-requests {
        color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .list > div {
        background: #3a3a3a !important;
        border-color: #505050 !important;
    }
    
    [data-theme="dark"] .list > div:hover {
        background: #454545 !important;
    }
    
    /* *** USER LEVEL BADGES IN DARK MODE *** */
    /* Regular - Darker background for better contrast */
    [data-theme="dark"] .badge-regular {
        background: #2d2d2d !important;
        color: #a0a0a0 !important;
    }
    
    /* Admin - More saturated blue */
    [data-theme="dark"] .badge-admin {
        background: #1e3a8a !important;
        color: #93c5fd !important;
    }
    
    /* Superuser - More saturated gold/amber */
    [data-theme="dark"] .badge-superuser {
        background: #92400e !important;
        color: #fbbf24 !important;
    }
    
    /* Stream access badges */
    [data-theme="dark"] .badge-yes {
        background: #065f46 !important;
        color: #6ee7b7 !important;
    }
    
    [data-theme="dark"] .badge-no {
        background: #7f1d1d !important;
        color: #fca5a5 !important;
    }
    
    /* *** TABLE HEAD - DARK BLUE IN DARK MODE *** */
    [data-theme="dark"] .users-table th {
        background: #1e3a8a !important;
        color: #e0e7ff !important;
        border-color: #1e40af !important;
    }
    
    /* *** CHECKBOX LABEL IN DARK MODE *** */
    [data-theme="dark"] .checkbox-label {
        color: #e0e0e0 !important;
    }
    
    /* *** CANCEL BUTTON IN DARK MODE *** */
    [data-theme="dark"] .btn-cancel {
        background: #4b5563 !important;
        color: #e5e7eb !important;
    }
    
    [data-theme="dark"] .btn-cancel:hover {
        background: #6b7280 !important;
    }
    
    /* *** DELETE USER MODAL ELEMENTS IN DARK MODE *** */
    [data-theme="dark"] .delete-user-modal-body {
        color: #d1d5db !important;
    }
    
    [data-theme="dark"] .delete-user-modal-username {
        background: rgba(239, 68, 68, 0.2) !important;
        color: #fca5a5 !important;
    }
    
    [data-theme="dark"] .delete-user-modal-warning {
        background: rgba(251, 191, 36, 0.15) !important;
        color: #fbbf24 !important;
    }
    
    /* *** SUCCESS MODAL IN DARK MODE *** */
    [data-theme="dark"] .success-modal-box {
        background: #2d2d2d !important;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7) !important;
    }
    
    [data-theme="dark"] .success-modal-title {
        color: #34d399 !important;
    }
    
    [data-theme="dark"] .success-modal-message {
        color: #d1d5db !important;
    }
    
    .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0.5rem 2rem 1.5rem;
    }
    
    .btn-create {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
    }
    
    .btn-create:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
    }
    
    .table-controls {
        background: white;
        padding: 0.75rem 1.25rem;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .table-controls-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }
    
    .search-box {
        flex: 1;
        min-width: 250px;
        max-width: 350px;
        position: relative;
    }
    
    .search-input {
        width: 100%;
        padding: 0.55rem 0.85rem 0.55rem 2.25rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.15s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .search-icon {
        position: absolute;
        left: 0.7rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 1rem;
    }
    
    .results-info {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
    }
    
    .users-table-container {
        background: white;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .users-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .users-table thead {
        background: linear-gradient(135deg, #1e3a8a, #1e40af);
        color: white;
    }
    
    .users-table th {
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: capitalize;
        letter-spacing: 0.5px;
        cursor: pointer;
        user-select: none;
        position: relative;
        transition: background 0.15s ease;
    }
    
    .users-table th:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .users-table th.sortable::after {
        content: '‚Üï';
        margin-left: 0.5rem;
        opacity: 0.5;
        font-size: 0.8rem;
    }
    
    .users-table th.sort-asc::after {
        content: '‚Üë';
        opacity: 1;
    }
    
    .users-table th.sort-desc::after {
        content: '‚Üì';
        opacity: 1;
    }
    
    .users-table td {
        padding: 0.7rem 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        color: #374151;
        text-align: center;
        font-size: 0.9rem;
    }
    
    .users-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .username-link {
        color: #2563eb;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: color 0.15s ease;
    }
    
    .username-link:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }
    
    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .badge-admin {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .badge-regular {
        background: #e5e7eb;
        color: #374151;
    }
    
    .badge-yes {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-no {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .badge-superuser {
        background: #fef3c7;
        color: #92400e;
    }
    
    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal-box {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.8rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        transition: color 0.15s ease;
    }
    
    .modal-close:hover {
        color: #111827;
    }
    
    .form-group {
        margin-bottom: 1.25rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-input, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.15s ease;
    }
    
    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .form-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
    }
    
    .modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 2rem;
    }
    
    .btn-modal {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: filter 0.15s ease;
    }
    
    .btn-cancel {
        background: #e5e7eb;
        color: #374151;
    }
    
    .btn-save {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
    }
    
    .btn-delete-user {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-delete-user:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        filter: brightness(1.05);
    }
    
    .btn-delete-user:active {
        transform: translateY(0);
    }
    
    .btn-modal:hover {
        filter: brightness(0.95);
    }
    
    .note {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }
    
    .success-message {
        background: #d1fae5;
        color: #065f46;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }
    
    /* Delete User Confirmation Modal */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .delete-user-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        animation: fadeIn 0.2s ease;
    }
    
    .delete-user-modal {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }
    
    .delete-user-modal-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .delete-user-modal-icon {
        font-size: 2.5rem;
    }
    
    .delete-user-modal-title {
        font-size: 1.35rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }
    
    .delete-user-modal-body {
        color: #6b7280;
        margin-bottom: 1.5rem;
        line-height: 1.6;
        font-size: 0.95rem;
    }
    
    .delete-user-modal-username {
        font-weight: 700;
        color: #ef4444;
        font-size: 1.05rem;
        padding: 0.5rem 0.75rem;
        background: #fee2e2;
        border-radius: 6px;
        display: inline-block;
        margin: 0.5rem 0;
    }
    
    .delete-user-modal-warning {
        background: #fef3c7;
        color: #92400e;
        padding: 0.75rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-size: 0.85rem;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        line-height: 1.5;
    }
    
    .delete-user-modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }
    
    .delete-user-modal-btn {
        padding: 0.7rem 1.5rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .delete-user-modal-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .delete-user-modal-btn:active {
        transform: translateY(0);
    }
    
    .delete-user-modal-btn.cancel {
        background: #f3f4f6;
        color: #374151;
    }
    
    .delete-user-modal-btn.delete {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
    
    /* Success Modal */
    .success-modal-box {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        text-align: center;
    }
    
    .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: scaleIn 0.3s ease;
    }
    
    @keyframes scaleIn {
        from {
            transform: scale(0);
        }
        to {
            transform: scale(1);
        }
    }
    
    .success-modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #059669;
        margin-bottom: 0.5rem;
    }
    
    .success-modal-message {
        color: #6b7280;
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .btn-success-ok {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: filter 0.15s ease;
    }
    
    .btn-success-ok:hover {
        filter: brightness(1.1);
    }
    
    /* Friends Modal */
    .friends-modal-box { 
        background: #fff; 
        border-radius: 16px; 
        padding: 1.5rem; 
        max-width: 500px; 
        width: 90%; 
        max-height: 80vh; 
        overflow-y: auto; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
    }
    .friends-modal-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 1rem; 
    }
    .friends-modal-close { 
        background: none; 
        border: none; 
        font-size: 1.5rem; 
        color: #6b7280; 
        cursor: pointer; 
        padding: 0; 
        transition: color 0.15s ease; 
    }
    .friends-modal-close:hover { 
        color: #111827; 
    }
    
    .search { 
        position: relative; 
    }
    .search input { 
        width: 100%; 
        padding: 0.65rem 0.9rem; 
        border-radius: 10px; 
        border: 1px solid #e5e7eb; 
        outline: none; 
    }
    .search input:focus { 
        border-color: #3b82f6; 
        box-shadow: 0 0 0 3px rgba(59,130,246,.1); 
    }
    .user-chip { 
        padding: 0.35rem 0.6rem; 
        background: #f3f4f6; 
        border-radius: 999px; 
        font-size: 0.75rem; 
    }
    .list { 
        max-height: 450px; 
        overflow: auto; 
        margin-top: 0.75rem; 
    }
    .req { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 0.5rem; 
        border-radius: 8px; 
        border: 1px solid #eef2f7; 
        margin-bottom: 0.5rem; 
    }
    .empty { 
        text-align: center; 
        color: #6b7280; 
        padding: 1rem; 
    }
    .divider { 
        height: 1px; 
        background: #f0f2f5; 
        margin: 0.75rem 0 1rem; 
    }
    .muted { 
        color: #6b7280; 
    }
    
    /* Pagination */
    .pagination-container {
        background: white;
        padding: 0.65rem 1.25rem;
        border-radius: 0 0 12px 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .pagination-info {
        color: #6b7280;
        font-size: 0.8rem;
    }
    
    .pagination-controls {
        display: flex;
        gap: 0.4rem;
        align-items: center;
    }
    
    .page-btn {
        padding: 0.4rem 0.65rem;
        border: 1px solid #d1d5db;
        background: white;
        color: #374151;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.15s ease;
    }
    
    .page-btn:hover:not(:disabled) {
        background: #f3f4f6;
        border-color: #9ca3af;
    }
    
    .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .page-btn.active {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
        border-color: #2563eb;
    }
    
    .page-size-select {
        padding: 0.4rem 0.6rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        background: white;
    }
    
    .page-size-label {
        color: #6b7280;
        font-size: 0.8rem;
        margin-right: 0.4rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="table-controls">
        <div class="table-controls-left">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="search-input" placeholder="Search users..." oninput="handleSearch()">
            </div>
            <div class="results-info" id="results-info">
                Loading...
            </div>
        </div>
        <button class="btn-create" onclick="openCreateModal()">
            <span>+</span>
            <span>Create User</span>
        </button>
    </div>
    
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="username" onclick="handleSort('username')">Username</th>
                    <th class="sortable" data-sort="name" onclick="handleSort('name')">Name</th>
                    <th class="sortable" data-sort="email" onclick="handleSort('email')">Email</th>
                    <th class="sortable" data-sort="user_level" onclick="handleSort('user_level')">Level</th>
                    <th class="sortable" data-sort="allow_stream" onclick="handleSort('allow_stream')">Stream Access</th>
                    <th class="sortable" data-sort="date_joined" onclick="handleSort('date_joined')">Date Joined</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <tr>
                    <td colspan="6" class="loading">Loading users...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination-container">
        <div class="pagination-info" id="pagination-info">
            Showing 0 of 0 users
        </div>
        <div class="pagination-controls">
            <span class="page-size-label">Per page:</span>
            <select class="page-size-select" id="page-size" onchange="handlePageSizeChange()">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <button class="page-btn" id="prev-btn" onclick="prevPage()" disabled>‚Üê Prev</button>
            <span id="page-numbers" style="display: flex; gap: 0.25rem;"></span>
            <button class="page-btn" id="next-btn" onclick="nextPage()" disabled>Next ‚Üí</button>
        </div>
    </div>
</div>

<!-- Delete User Confirmation Modal -->
<div id="delete-user-modal-overlay" class="delete-user-modal-overlay" style="display: none;">
    <div class="delete-user-modal">
        <div class="delete-user-modal-header">
            <span class="delete-user-modal-icon">‚ö†Ô∏è</span>
            <h3 class="delete-user-modal-title">Delete User?</h3>
        </div>
        <div class="delete-user-modal-body">
            Are you sure you want to permanently delete the user:
            <div class="delete-user-modal-username" id="delete-user-name"></div>
            <div class="delete-user-modal-warning">
                <span>‚ö†Ô∏è</span>
                <span>This action cannot be undone. All user data, recordings, and associated information will be permanently removed.</span>
            </div>
        </div>
        <div class="delete-user-modal-actions">
            <button class="delete-user-modal-btn cancel" onclick="closeDeleteUserModal()">Cancel</button>
            <button class="delete-user-modal-btn delete" onclick="confirmDeleteUser()">Delete User</button>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div id="create-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateModal()">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="modal-title">Create New User</h2>
            <button class="modal-close" onclick="closeCreateModal()">&times;</button>
        </div>
        
        <div id="create-error" class="error-message" style="display:none;"></div>
        
        <form id="create-form" onsubmit="handleCreateUser(event)">
            <div class="form-group">
                <label class="form-label">Username *</label>
                <input type="text" class="form-input" name="username" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Password *</label>
                <input type="password" class="form-input" name="password" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" name="name">
                <div class="note">Optional</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" name="email">
                <div class="note">Optional</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">User Level</label>
                <select class="form-select" name="user_level">
                    <option value="regular">Regular</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" name="allow_stream" checked>
                    Allow Streaming
                </label>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn-modal btn-save">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-modal" class="modal-overlay" onclick="if(event.target === this) closeEditModal()">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="modal-title">Edit User</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        
        <div id="edit-error" class="error-message" style="display:none;"></div>
        
        <form id="edit-form" onsubmit="handleEditUser(event)">
            <input type="hidden" name="user_id" id="edit-user-id">
            
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="edit-username" readonly style="background:#f3f4f6;">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" name="password" id="edit-password">
                <div class="note">Leave blank to keep current password</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" name="name" id="edit-name">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" name="email" id="edit-email">
            </div>
            
            <div class="form-group">
                <label class="form-label">User Level</label>
                <select class="form-select" name="user_level" id="edit-user-level">
                    <option value="regular">Regular</option>
                    <option value="admin">Admin</option>
                </select>
                <div class="note" id="edit-superuser-note" style="display:none;">This is a superuser - admin privileges are permanent</div>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" class="form-checkbox" name="allow_stream" id="edit-allow-stream">
                    Allow Streaming
                </label>
                <div class="note" id="edit-stream-note" style="display:none;">Admins can always stream</div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-delete-user" id="btn-delete-user" onclick="showDeleteUserModal()">
                    <span>üóëÔ∏è</span>
                    <span>Delete User</span>
                </button>
                <div style="flex: 1;"></div>
                <button type="button" class="btn-modal btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button type="submit" class="btn-modal btn-save">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div id="success-modal" class="modal-overlay" onclick="if(event.target === this) closeSuccessModal()">
    <div class="success-modal-box">
        <div class="success-icon">‚úì</div>
        <div class="success-modal-title" id="success-modal-title">Success!</div>
        <div class="success-modal-message" id="success-modal-message">Operation completed successfully</div>
        <button class="btn-success-ok" onclick="closeSuccessModal()">OK</button>
    </div>
</div>

<!-- Friends Modal -->
<div id="friends-modal" class="modal-overlay" onclick="if(event.target === this) closeFriendsModal()">
    <div class="friends-modal-box">
        <div class="friends-modal-header">
            <h2 style="margin: 0;">Friends</h2>
            <button class="friends-modal-close" onclick="closeFriendsModal()">&times;</button>
        </div>
        <div class="divider" style="margin: 0.5rem 0 1rem;"></div>
        
        <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Find Friends</h2>
        <div class="search">
            <input id="friends-search-input" type="text" placeholder="Search usernames..." autocomplete="off" />
        </div>
        <div id="friends-search-results" class="list"></div>
        
        <div class="divider"></div>
        
        <h2 style="font-size: 1rem; margin-bottom: 0.75rem;">Friend Requests</h2>
        <div id="friends-requests" class="list"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allUsers = [];
let filteredUsers = [];
let currentPage = 1;
let pageSize = 10;
let sortColumn = 'username';
let sortDirection = 'asc';
let searchQuery = '';

function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? decodeURIComponent(m.pop()) : null;
}

async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users/', {
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error('Failed to load users');
        }
        
        const data = await response.json();
        allUsers = data.users;
        applyFiltersAndSort();
        renderUsersTable();
        updatePagination();
    } catch (error) {
        document.getElementById('users-table-body').innerHTML = 
            `<tr><td colspan="6" style="text-align:center;color:#ef4444;">Error loading users: ${error.message}</td></tr>`;
    }
}

function applyFiltersAndSort() {
    // Filter by search query
    if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase();
        filteredUsers = allUsers.filter(user => {
            return (user.username || '').toLowerCase().includes(query) ||
                   (user.name || '').toLowerCase().includes(query) ||
                   (user.email || '').toLowerCase().includes(query) ||
                   (user.user_level || '').toLowerCase().includes(query);
        });
    } else {
        filteredUsers = [...allUsers];
    }
    
    // Sort
    filteredUsers.sort((a, b) => {
        let aVal = a[sortColumn];
        let bVal = b[sortColumn];
        
        // Handle null/undefined values
        if (aVal === null || aVal === undefined) aVal = '';
        if (bVal === null || bVal === undefined) bVal = '';
        
        // Convert to strings for comparison if needed
        if (sortColumn === 'date_joined') {
            aVal = new Date(aVal || 0);
            bVal = new Date(bVal || 0);
        } else if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = (bVal || '').toLowerCase();
        }
        
        if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Reset to first page when filters change
    currentPage = 1;
}

function handleSearch() {
    searchQuery = document.getElementById('search-input').value;
    applyFiltersAndSort();
    renderUsersTable();
    updatePagination();
}

function handleSort(column) {
    if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortColumn = column;
        sortDirection = 'asc';
    }
    
    // Update sort indicators
    document.querySelectorAll('.users-table th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    const th = document.querySelector(`th[data-sort="${column}"]`);
    if (th) {
        th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
    }
    
    applyFiltersAndSort();
    renderUsersTable();
    updatePagination();
}

function handlePageSizeChange() {
    pageSize = parseInt(document.getElementById('page-size').value);
    currentPage = 1;
    renderUsersTable();
    updatePagination();
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderUsersTable();
        updatePagination();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredUsers.length / pageSize);
    if (currentPage < totalPages) {
        currentPage++;
        renderUsersTable();
        updatePagination();
    }
}

function goToPage(page) {
    currentPage = page;
    renderUsersTable();
    updatePagination();
}

function updatePagination() {
    const totalUsers = filteredUsers.length;
    const totalPages = Math.ceil(totalUsers / pageSize);
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = Math.min(startIdx + pageSize, totalUsers);
    
    // Update info texts
    document.getElementById('results-info').textContent = 
        `${totalUsers} user${totalUsers !== 1 ? 's' : ''} found`;
    document.getElementById('pagination-info').textContent = 
        `Showing ${totalUsers > 0 ? startIdx + 1 : 0}-${endIdx} of ${totalUsers} users`;
    
    // Update prev/next buttons
    document.getElementById('prev-btn').disabled = currentPage === 1;
    document.getElementById('next-btn').disabled = currentPage === totalPages || totalPages === 0;
    
    // Update page numbers
    const pageNumbersContainer = document.getElementById('page-numbers');
    pageNumbersContainer.innerHTML = '';
    
    if (totalPages <= 7) {
        // Show all pages
        for (let i = 1; i <= totalPages; i++) {
            pageNumbersContainer.appendChild(createPageButton(i));
        }
    } else {
        // Show first, last, and pages around current
        pageNumbersContainer.appendChild(createPageButton(1));
        
        if (currentPage > 3) {
            pageNumbersContainer.appendChild(createEllipsis());
        }
        
        for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
            pageNumbersContainer.appendChild(createPageButton(i));
        }
        
        if (currentPage < totalPages - 2) {
            pageNumbersContainer.appendChild(createEllipsis());
        }
        
        if (totalPages > 1) {
            pageNumbersContainer.appendChild(createPageButton(totalPages));
        }
    }
}

function createPageButton(page) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (page === currentPage ? ' active' : '');
    btn.textContent = page;
    btn.onclick = () => goToPage(page);
    return btn;
}

function createEllipsis() {
    const span = document.createElement('span');
    span.textContent = '...';
    span.style.padding = '0.5rem';
    span.style.color = '#6b7280';
    return span;
}

function renderUsersTable() {
    const tbody = document.getElementById('users-table-body');
    
    if (filteredUsers.length === 0) {
        const message = searchQuery.trim() 
            ? 'No users match your search' 
            : 'No users found';
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#6b7280;">${message}</td></tr>`;
        return;
    }
    
    // Get paginated users
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const paginatedUsers = filteredUsers.slice(startIdx, endIdx);
    
    tbody.innerHTML = paginatedUsers.map(user => {
        const levelBadge = user.is_superuser 
            ? '<span class="badge badge-superuser">Superuser</span>' 
            : user.user_level === 'admin' 
                ? '<span class="badge badge-admin">Admin</span>' 
                : '<span class="badge badge-regular">Regular</span>';
        
        const streamBadge = user.allow_stream || user.user_level === 'admin' || user.is_superuser
            ? '<span class="badge badge-yes">Yes</span>'
            : '<span class="badge badge-no">No</span>';
        
        const dateJoined = user.date_joined ? new Date(user.date_joined).toLocaleDateString() : 'N/A';
        
        return `
            <tr>
                <td><a class="username-link" onclick="openEditModal(${user.id})">${user.username}</a></td>
                <td>${user.name || '-'}</td>
                <td>${user.email || '-'}</td>
                <td>${levelBadge}</td>
                <td>${streamBadge}</td>
                <td>${dateJoined}</td>
            </tr>
        `;
    }).join('');
}

function openCreateModal() {
    document.getElementById('create-modal').classList.add('active');
    document.getElementById('create-form').reset();
    document.getElementById('create-error').style.display = 'none';
}

function closeCreateModal() {
    document.getElementById('create-modal').classList.remove('active');
}

async function handleCreateUser(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    const data = {
        username: formData.get('username'),
        password: formData.get('password'),
        name: formData.get('name'),
        email: formData.get('email'),
        user_level: formData.get('user_level'),
        allow_stream: formData.get('allow_stream') === 'on'
    };
    
    try {
        const response = await fetch('/api/admin/users/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to create user');
        }
        
        closeCreateModal();
        loadUsers();
        showSuccessModal('User Created!', `User "${data.username}" has been created successfully.`);
    } catch (error) {
        document.getElementById('create-error').textContent = error.message;
        document.getElementById('create-error').style.display = 'block';
    }
}

function openEditModal(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    document.getElementById('edit-user-id').value = user.id;
    document.getElementById('edit-username').value = user.username;
    document.getElementById('edit-password').value = '';
    document.getElementById('edit-name').value = user.name || '';
    document.getElementById('edit-email').value = user.email || '';
    document.getElementById('edit-user-level').value = user.user_level;
    document.getElementById('edit-allow-stream').checked = user.allow_stream;
    document.getElementById('edit-error').style.display = 'none';
    
    // Show notes for superusers and admins
    if (user.is_superuser) {
        document.getElementById('edit-superuser-note').style.display = 'block';
        document.getElementById('edit-user-level').disabled = true;
    } else {
        document.getElementById('edit-superuser-note').style.display = 'none';
        document.getElementById('edit-user-level').disabled = false;
    }
    
    if (user.user_level === 'admin' || user.is_superuser) {
        document.getElementById('edit-stream-note').style.display = 'block';
        document.getElementById('edit-allow-stream').disabled = true;
        document.getElementById('edit-allow-stream').checked = true;
    } else {
        document.getElementById('edit-stream-note').style.display = 'none';
        document.getElementById('edit-allow-stream').disabled = false;
    }
    
    // Hide delete button if editing yourself or if admin trying to delete another admin (only superuser can)
    const deleteBtn = document.getElementById('btn-delete-user');
    const isSuperuser = {{ request.user.is_superuser|lower }};
    
    if (user.username === '{{ request.user.username }}') {
        // Can't delete yourself
        deleteBtn.style.display = 'none';
    } else if (user.user_level === 'admin' && !isSuperuser) {
        // Only superuser can delete admin users
        deleteBtn.style.display = 'none';
    } else {
        deleteBtn.style.display = 'inline-flex';
    }
    
    document.getElementById('edit-modal').classList.add('active');
}

function closeEditModal() {
    document.getElementById('edit-modal').classList.remove('active');
}

async function handleEditUser(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const userId = formData.get('user_id');
    
    const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        user_level: formData.get('user_level'),
        allow_stream: formData.get('allow_stream') === 'on'
    };
    
    // Only include password if provided
    const password = formData.get('password');
    if (password) {
        data.password = password;
    }
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to update user');
        }
        
        closeEditModal();
        loadUsers();
        const username = allUsers.find(u => u.id == userId)?.username || 'User';
        showSuccessModal('User Updated!', `User "${username}" has been updated successfully.`);
    } catch (error) {
        document.getElementById('edit-error').textContent = error.message;
        document.getElementById('edit-error').style.display = 'block';
    }
}

function showSuccessModal(title, message) {
    document.getElementById('success-modal-title').textContent = title;
    document.getElementById('success-modal-message').textContent = message;
    document.getElementById('success-modal').classList.add('active');
}

// Delete User Functions
let currentDeleteUserId = null;

function showDeleteUserModal() {
    const userId = document.getElementById('edit-user-id').value;
    const username = document.getElementById('edit-username').value;
    
    currentDeleteUserId = userId;
    document.getElementById('delete-user-name').textContent = username;
    document.getElementById('delete-user-modal-overlay').style.display = 'flex';
}

function closeDeleteUserModal() {
    currentDeleteUserId = null;
    document.getElementById('delete-user-modal-overlay').style.display = 'none';
}

async function confirmDeleteUser() {
    if (!currentDeleteUserId) return;
    
    const userId = currentDeleteUserId;
    const username = document.getElementById('edit-username').value;
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/delete/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Failed to delete user');
        }
        
        closeDeleteUserModal();
        closeEditModal();
        loadUsers();
        showSuccessModal('User Deleted!', `User "${username}" has been permanently deleted.`);
    } catch (error) {
        closeDeleteUserModal();
        document.getElementById('edit-error').textContent = error.message;
        document.getElementById('edit-error').style.display = 'block';
    }
}

// Click outside to close delete modal
document.addEventListener('click', (event) => {
    const overlay = document.getElementById('delete-user-modal-overlay');
    if (event.target === overlay) {
        closeDeleteUserModal();
    }
});

function closeSuccessModal() {
    document.getElementById('success-modal').classList.remove('active');
}

// Friends modal functions
window.addEventListener('toggleFriendsPanel', ()=>{
    openFriendsModal();
});

function openFriendsModal() {
    document.getElementById('friends-modal').classList.add('active');
    refreshFriendsRequests();
}

function closeFriendsModal() {
    document.getElementById('friends-modal').classList.remove('active');
    document.getElementById('friends-search-input').value = '';
    document.getElementById('friends-search-results').innerHTML = '';
}

async function refreshFriendsRequests() { 
    const r = await fetch('/api/friends/requests/', { credentials: 'same-origin' }); 
    if(!r.ok){ console.error('Requests fetch failed', r.status); return; } 
    const j = await r.json(); 
    const box = document.getElementById('friends-requests'); 
    box.innerHTML=''; 
    if(!(j.received?.length||j.sent?.length)){ 
        box.innerHTML='<div class="empty">No pending requests</div>'; 
        return; 
    } 
    (j.received||[]).forEach(u=>{ 
        const el=document.createElement('div'); 
        el.className='req'; 
        el.innerHTML=`<div>${u}</div><div><button class="btn btn-success" style="padding:0.35rem 0.75rem;" onclick="actFriendReq('accept','${u}')">Accept</button> <button class="btn btn-danger" style="padding:0.35rem 0.75rem;" onclick="actFriendReq('reject','${u}')">Reject</button></div>`; 
        box.appendChild(el); 
    }); 
    (j.sent||[]).forEach(u=>{ 
        const el=document.createElement('div'); 
        el.className='req'; 
        el.innerHTML=`<div>${u}<div class="muted" style="font-size:0.75rem;margin-top:0.15rem;">Request Sent</div></div><div><button class="btn btn-danger" style="padding:0.35rem 0.75rem;" onclick="undoFriendReq('${u}')">Undo Request</button></div>`; 
        box.appendChild(el); 
    }); 
}

async function actFriendReq(action, username){ 
    const ep = action==='accept' ? '/api/friends/accept/' : '/api/friends/reject/'; 
    await fetch(ep,{method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')}, body: JSON.stringify({ username })}); 
    refreshFriendsRequests(); 
}

async function doFriendSearch(q){ 
    const r=await fetch(`/api/users/search/?q=${encodeURIComponent(q)}`, { credentials: 'same-origin' }); 
    if(!r.ok){ console.error('Search fetch failed', r.status); return; } 
    const j=await r.json(); 
    const list=document.getElementById('friends-search-results'); 
    list.innerHTML=''; 
    if(!(j.results||[]).length){ 
        list.innerHTML='<div class="empty">No users found</div>'; 
        return; 
    } 
    j.results.forEach(it=>{ 
        const row=document.createElement('div'); 
        row.className='req'; 
        row.innerHTML=`<div>${it.username}${it.friendship_status === 'sent_pending' ? '<div class="muted" style="font-size:0.75rem;margin-top:0.15rem;">Request Sent</div>' : ''}</div><div>${renderFriendSearchActions(it)}</div>`; 
        list.appendChild(row); 
    }); 
}

function renderFriendSearchActions(it){ 
    if(it.friendship_status === 'sent_pending') return '<button class="btn btn-danger" style="padding:0.35rem 0.75rem;" onclick="undoFriendReq(\''+it.username+'\')">Undo Request</button>'; 
    if(it.friendship_status === 'sent_accepted' || it.friendship_status === 'received_accepted') return '<span class="muted" style="color:#10b981;font-weight:600;"><span style="font-size:1.1em;">‚úì</span> Already Friends</span>'; 
    if(it.friendship_status.startsWith('received_')) return `<button class="btn btn-success" style="padding:0.35rem 0.75rem;" onclick="actFriendReq('accept','${it.username}')">Accept</button> <button class="btn btn-danger" style="padding:0.35rem 0.75rem;" onclick="actFriendReq('reject','${it.username}')">Reject</button>`; 
    return `<button class="btn btn-primary" style="padding:0.35rem 0.75rem;" onclick="sendFriendReq('${it.username}')">Add</button>`; 
}

async function sendFriendReq(username){ 
    await fetch('/api/friends/request/',{method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')}, body: JSON.stringify({ username })}); 
    doFriendSearch(document.getElementById('friends-search-input').value || ''); 
    refreshFriendsRequests(); 
}

async function undoFriendReq(username){ 
    await fetch('/api/friends/undo/',{method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')}, body: JSON.stringify({ username })}); 
    const searchVal = document.getElementById('friends-search-input').value || '';
    if(searchVal) doFriendSearch(searchVal); 
    refreshFriendsRequests(); 
}

document.getElementById('friends-search-input').addEventListener('input', (e)=>{ 
    const q=e.target.value.trim(); 
    if(q.length<1){ 
        document.getElementById('friends-search-results').innerHTML=''; 
        return;
    } 
    doFriendSearch(q); 
});

// Load users on page load
loadUsers();
</script>
{% endblock %}
